{% extends 'base.html' %}

{% block title %}Gestión de Productos{% endblock %}

{% block body %}
<nav class="navbar bg-dark fixed-top" data-bs-theme="dark">
  <div class="container">
    <a class="navbar-brand fw-bold" href="#">
        <img src="{{ url_for('static', filename='images/logo_la_poblanita.png') }}" width="40" height="40">
        Productos
    </a>
    <div class="d-flex align-items-center">
        <!-- Foto perfil -->
        <a href="{{ url_for('profile') }}" class="me-3">
            <img src="{{ url_for('profile_picture', usuario_id=usuario.id_empleado) }}" class="rounded-circle" width="35" height="35">
        </a>
        <a href="{{ url_for('home') }}" class="btn btn-sm btn-outline-light">
            <i class="bi bi-house"></i> Inicio
        </a>
    </div>
  </div>
</nav>

<div class="container mt-5 pt-5">
    <!-- Botones de acción -->
    {% if error %}
    <div class="alert alert-danger alert-dismissible fade show mt-4" role="alert">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <strong>Error al eliminar producto o generar paquete:</strong> 
        <div class="mt-2">{{ error | safe }}</div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <!-- Buscador y botones de acción -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <!-- Buscador -->
        <div class="d-flex align-items-center" style="max-width: 400px;">
            <form method="GET" action="{{ url_for('products') }}" class="d-flex w-100" id="searchForm">
                <div class="input-group">
                    <input type="text" name="busqueda" class="form-control" placeholder="Buscar productos..." 
                           value="{{ busqueda or '' }}" id="searchInput" autofocus>
                    <button class="btn btn-outline-primary" type="submit">
                        <i class="bi bi-search"></i>
                    </button>
                    {% if busqueda %}
                    <a href="{{ url_for('products') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-x"></i>
                    </a>
                    {% endif %}
                </div>
            </form>
        </div>

        <div class="d-flex flex-column gap-2">
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalAgregar">
                <i class="bi bi-plus"></i> Nuevo producto
            </button>
            <button class="btn btn-warning" id="btnGenerarPaquete" disabled>
                <i class="bi bi-box-seam"></i> Generar paquete
            </button>
        </div>
    </div>

    <!-- Información de búsqueda -->
    {% if busqueda %}
    <div class="alert alert-info d-flex justify-content-between align-items-center">
        <div>
            <i class="bi bi-info-circle"></i>
            Resultados de búsqueda para: <strong>"{{ busqueda }}"</strong>
            <span class="badge bg-primary ms-2">{{ pagination.total }} resultado(s)</span>
        </div>
        <a href="{{ url_for('products') }}" class="btn btn-sm btn-outline-info">
            <i class="bi bi-x-circle"></i> Limpiar búsqueda
        </a>
    </div>
    {% endif %}

    <!-- Contador de selección -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <span class="text-white" id="contador-seleccion">0 productos seleccionados</span>
        {% if busqueda %}
        <span class="badge bg-info">Búsqueda activa: "{{ busqueda }}"</span>
        {% endif %}
    </div>

    <!-- Tabla de Productos -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th width="150">ID Producto</th>
                            <th>Nombre</th>
                            <th>Código Barras</th>
                            <th>Stock</th>
                            <th>Imagen</th>
                            <th>Seleccionar</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for producto in productos %}
                        <tr data-producto-id="{{ producto.id_producto }}">
                            <td>P-{{ (pagination.page - 1) * pagination.per_page + loop.index }}</td>
                            <td>{{ producto.nombre }}</td>
                            <td>
                                {% if producto.codigo_barras %}
                                <span class="badge bg-dark">{{ producto.codigo_barras }}</span>
                                {% else %}
                                <span class="text-muted">Sin código</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-secondary">{{ producto.cantidad }}</span>
                                <div class="progress mt-1" style="height: 5px;">
                                    {% set max_stock = 100 %}
                                    {% set porcentaje = (producto.cantidad / max_stock) * 100 %}
                                    {% set porcentaje = porcentaje if porcentaje <= 100 else 100 %}
                                    <div class="progress-bar 
                                        {% if producto.cantidad == 0 %}bg-danger
                                        {% elif producto.cantidad < 10 %}bg-warning
                                        {% elif producto.cantidad < 25 %}bg-info
                                        {% else %}bg-success{% endif %}" 
                                        style="width: {{ '%.1f'|format(porcentaje) }}%">
                                    </div>
                                </div>
                            </td>
                            <td>
                                <img src="{{ url_for('product_image', producto_id=producto.id_producto) }}" 
                                     width="40" height="40" class="rounded">
                            </td>
                            <td>
                                <div class="input-group input-group-sm">
                                    <input type="number" class="form-control cantidad-input" 
                                           min="0" max="{{ producto.cantidad }}" 
                                           placeholder="0" style="width: 70px;">
                                </div>
                            </td>
                            <td>
                                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" 
                                        data-bs-target="#modalEditar" 
                                        data-id="{{ producto.id_producto }}"
                                        data-nombre="{{ producto.nombre }}"
                                        data-cantidad="{{ producto.cantidad }}"
                                        data-codigo-barras="{{ producto.codigo_barras or '' }}">
                                    Editar
                                </button>
                                <form method="POST" action="{{ url_for('delete_product', id=producto.id_producto) }}" 
                                    class="d-inline" onsubmit="return confirm('¿Estás seguro de que quieres eliminar el producto {{ producto.nombre }}?');">
                                    <button type="submit" class="btn btn-danger btn-sm">Borrar</button>
                                </form>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center py-4">
                                {% if busqueda %}
                                <div class="text-muted">
                                    <i class="bi bi-search display-4"></i>
                                    <h5>No se encontraron productos</h5>
                                    <p>No hay resultados para "{{ busqueda }}"</p>
                                    <a href="{{ url_for('products') }}" class="btn btn-primary">
                                        <i class="bi bi-arrow-left"></i> Ver todos los productos
                                    </a>
                                </div>
                                {% else %}
                                <div class="text-muted">
                                    <i class="bi bi-box display-4"></i>
                                    <h5>No hay productos</h5>
                                    <p>Comienza agregando el primer producto</p>
                                </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Paginación -->
            {% if pagination.pages > 1 %}
            <nav aria-label="Page navigation" class="mt-3">
                <ul class="pagination justify-content-center">
                    <!-- Botón Anterior -->
                    <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('products', pagina=pagination.prev_num, busqueda=busqueda) if pagination.has_prev else '#' }}">
                            <i class="bi bi-chevron-left"></i>---
                        </a>
                    </li>

                    <!-- Números de página -->
                    {% for page_num in pagination.iter_pages(left_edge=2, left_current=2, right_current=2, right_edge=2) %}
                        {% if page_num %}
                            <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                                <a class="page-link" href="{{ url_for('products', pagina=page_num, busqueda=busqueda) }}">{{ page_num }}</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        {% endif %}
                    {% endfor %}

                    <!-- Botón Siguiente -->
                    <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('products', pagina=pagination.next_num, busqueda=busqueda) if pagination.has_next else '#' }}">
                            ---<i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
            {% endif %}

            <!-- Información de paginación -->
            <div class="text-center text-muted small mt-2">
                Mostrando {{ productos|length }} de {{ pagination.total }} productos
                (Página {{ pagination.page }} de {{ pagination.pages }})
                {% if busqueda %}
                <span class="badge bg-info ms-2">Búsqueda: "{{ busqueda }}"</span>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal Agregar Producto -->
<div class="modal fade" id="modalAgregar">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Agregar Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_product') }}" enctype="multipart/form-data">
                <div class="modal-body">
                    <input type="text" name="nombre" class="form-control mb-2" placeholder="Nombre" required>
                    <input type="number" name="cantidad" class="form-control mb-2" placeholder="Cantidad" min="0" required>
                    <input type="text" name="codigo_barras" class="form-control mb-2" placeholder="Código de barras" required>
                    <input type="file" name="imagen" class="form-control" accept="image/*">
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Agregar</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Editar Producto -->
<div class="modal fade" id="modalEditar">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="formEditar" enctype="multipart/form-data">
                <div class="modal-body">
                    <input type="text" name="nombre" class="form-control mb-2" placeholder="Nombre" required id="editNombre">
                    <input type="number" name="cantidad" class="form-control mb-2" placeholder="Cantidad" min="0" required id="editCantidad">
                    <input type="text" name="codigo_barras" class="form-control mb-2" placeholder="Código de barras" required id="editCodigoBarras">
                    <input type="file" name="imagen" class="form-control" accept="image/*">
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Actualizar</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Formulario oculto para generar paquete -->
<form method="POST" action="{{ url_for('generate_package') }}" id="formPaquete" style="display: none;">
    <input type="hidden" name="productos_data" id="productosData">
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const cantidadInputs = document.querySelectorAll('.cantidad-input');
    const btnGenerar = document.getElementById('btnGenerarPaquete');
    const contador = document.getElementById('contador-seleccion');
    const formPaquete = document.getElementById('formPaquete');
    const productosData = document.getElementById('productosData');

    // Enfocar automáticamente el campo de búsqueda
    searchInput.focus();

    // Modal editar
    const modalEditar = document.getElementById('modalEditar');
    modalEditar.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const form = document.getElementById('formEditar');
        form.action = `/products/edit/${button.dataset.id}`;
        document.getElementById('editNombre').value = button.dataset.nombre;
        document.getElementById('editCantidad').value = button.dataset.cantidad;
        document.getElementById('editCodigoBarras').value = button.dataset.codigoBarras;
    });

    // Control de selección
    function actualizarSeleccion() {
        let totalSeleccionados = 0;
        let productosSeleccionados = [];
        
        cantidadInputs.forEach(input => {
            const cantidad = parseInt(input.value) || 0;
            if (cantidad > 0) {
                totalSeleccionados++;
                const productoId = input.closest('tr').dataset.productoId;
                productosSeleccionados.push({
                    id: productoId,
                    cantidad: cantidad
                });
            }
        });
        
        contador.textContent = `${totalSeleccionados} productos seleccionados`;
        btnGenerar.disabled = totalSeleccionados === 0;
        
        // Guardar datos para el formulario
        productosData.value = JSON.stringify(productosSeleccionados);
    }

    cantidadInputs.forEach(input => {
        input.addEventListener('input', actualizarSeleccion);
    });

    btnGenerar.addEventListener('click', function() {
        formPaquete.submit();
    });
});
</script>
{% endblock %}
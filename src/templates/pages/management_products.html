{% extends 'base.html' %}

{% block title %}Gestión de Productos{% endblock %}

{% block body %}
<nav class="navbar bg-dark fixed-top" data-bs-theme="dark">
  <div class="container">
    <a class="navbar-brand fw-bold" href="#">
        <img src="{{ url_for('static', filename='images/logo_la_poblanita.png') }}" width="40" height="40">
        Productos
    </a>
    <div class="d-flex align-items-center">
        <a href="{{ url_for('profile') }}" class="me-3">
            <img src="{{ url_for('profile_picture', usuario_id=usuario.id_empleado) }}" class="rounded-circle" width="35" height="35">
        </a>
        <a href="{{ url_for('home') }}" class="btn btn-sm btn-outline-light">
            <i class="bi bi-house"></i> Inicio
        </a>
    </div>
  </div>
</nav>

<div class="container mt-5 pt-5">
    {% if error %}
    <div class="alert alert-danger alert-dismissible fade show mt-4" role="alert">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <strong>Error al eliminar producto o generar paquete:</strong> 
        <div class="mt-2">{{ error | safe }}</div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center" style="max-width: 400px;">
            <form method="GET" action="{{ url_for('products') }}" class="d-flex w-100" id="searchForm">
                <div class="input-group">
                    <input type="text" name="busqueda" class="form-control" placeholder="Buscar productos..." 
                           value="{{ busqueda or '' }}" id="searchInput">
                    <button class="btn btn-outline-primary" type="submit">
                        <i class="bi bi-search"></i>
                    </button>
                    {% if busqueda or filtro_nombre or filtro_codigo or filtro_stock_min or filtro_stock_max %}
                    <a href="{{ url_for('products') }}" class="btn btn-outline-secondary" title="Limpiar todos los filtros">
                        <i class="bi bi-x-circle"></i>
                    </a>
                    {% endif %}
                </div>
            </form>
        </div>

        <div class="d-flex flex-column gap-2">
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalAgregar">
                <i class="bi bi-plus"></i> Nuevo producto
            </button>
            <button class="btn btn-warning position-relative" id="btnGenerarPaquete" disabled>
                <i class="bi bi-box-seam"></i> Generar paquete
                <span id="paqueteBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">
                    0
                </span>
            </button>
        </div>
    </div>

    {% if busqueda or filtro_nombre or filtro_codigo or filtro_stock_min or filtro_stock_max %}
    <div class="alert alert-info d-flex justify-content-between align-items-center">
        <div>
            <i class="bi bi-funnel"></i>
            <strong>Filtros activos:</strong>
            {% if busqueda %}<span class="badge bg-primary ms-1">Búsqueda: "{{ busqueda }}"</span>{% endif %}
            {% if filtro_nombre %}<span class="badge bg-primary ms-1">Nombre: "{{ filtro_nombre }}"</span>{% endif %}
            {% if filtro_codigo %}<span class="badge bg-primary ms-1">Código: "{{ filtro_codigo }}"</span>{% endif %}
            {% if filtro_stock_min %}<span class="badge bg-primary ms-1">Stock min: {{ filtro_stock_min }}</span>{% endif %}
            {% if filtro_stock_max %}<span class="badge bg-primary ms-1">Stock max: {{ filtro_stock_max }}"</span>{% endif %}
            <span class="badge bg-dark ms-2">{{ pagination.total }} resultado(s)</span>
        </div>
        <a href="{{ url_for('products') }}" class="btn btn-sm btn-outline-info">
            <i class="bi bi-x-circle"></i> Limpiar filtros
        </a>
    </div>
    {% endif %}

    <div class="d-flex justify-content-between align-items-center mb-3">
        <span class="text-white" id="contador-seleccion">0 productos seleccionados</span>
        <div>
            {% if busqueda or filtro_nombre or filtro_codigo or filtro_stock_min or filtro_stock_max %}
            <span class="badge bg-info">Filtros aplicados</span>
            {% endif %}
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                <form method="GET" action="{{ url_for('products') }}" id="filterForm">
                    <input type="hidden" name="busqueda" value="{{ busqueda }}">
                    
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th width="150">ID Producto</th>
                                <th>
                                    <div class="d-flex align-items-center">
                                        <span>Nombre</span>
                                        <div class="ms-2" style="min-width: 150px;">
                                            <input type="text" 
                                                   name="filtro_nombre" 
                                                   class="form-control form-control-sm" 
                                                   placeholder="Filtrar nombre..."
                                                   value="{{ filtro_nombre or '' }}"
                                                   onchange="document.getElementById('filterForm').submit()">
                                        </div>
                                    </div>
                                </th>
                                <th>
                                    <div class="d-flex align-items-center">
                                        <span>Código Barras</span>
                                        <div class="ms-2" style="min-width: 150px;">
                                            <input type="text" 
                                                   name="filtro_codigo" 
                                                   class="form-control form-control-sm" 
                                                   placeholder="Filtrar código..."
                                                   value="{{ filtro_codigo or '' }}"
                                                   onchange="document.getElementById('filterForm').submit()">
                                        </div>
                                    </div>
                                </th>
                                <th>
                                    <div class="d-flex align-items-center">
                                        <span>Stock</span>
                                        <div class="ms-2" style="min-width: 150px;">
                                            <div class="input-group input-group-sm">
                                                <input type="number" 
                                                       name="filtro_stock_min" 
                                                       class="form-control" 
                                                       placeholder="Min"
                                                       value="{{ filtro_stock_min or '' }}"
                                                       onchange="document.getElementById('filterForm').submit()">
                                                <input type="number" 
                                                       name="filtro_stock_max" 
                                                       class="form-control" 
                                                       placeholder="Max"
                                                       value="{{ filtro_stock_max or '' }}"
                                                       onchange="document.getElementById('filterForm').submit()">
                                            </div>
                                        </div>
                                    </div>
                                </th>
                                <th>Imagen</th>
                                <th>Seleccionar</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for producto in productos %}
                            <tr data-producto-id="{{ producto.id_producto }}">
                                <td>P-{{ producto.id_producto }}</td>
                                <td>{{ producto.nombre }}</td>
                                <td>
                                    {% if producto.codigo_barras %}
                                    <span class="badge bg-dark">{{ producto.codigo_barras }}</span>
                                    {% else %}
                                    <span class="text-muted">Sin código</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ producto.cantidad }}</span>
                                    <div class="progress mt-1" style="height: 8px;">
                                        {% set max_stock = 100 %}
                                        {% set porcentaje = (producto.cantidad / max_stock) * 100 %}
                                        {% set porcentaje = porcentaje if porcentaje <= 100 else 100 %}
                                        <div class="progress-bar 
                                            {% if producto.cantidad == 0 %}bg-danger
                                            {% elif producto.cantidad < 10 %}bg-warning
                                            {% elif producto.cantidad < 25 %}bg-info
                                            {% else %}bg-success{% endif %}" 
                                            style="width: {{ '%.1f'|format(porcentaje) }}%">
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <img src="{{ url_for('product_image', producto_id=producto.id_producto) }}" 
                                         width="60" height="60" class="rounded">
                                </td>
                                <td>
                                    <div class="input-group input-group-sm">
                                        <input type="number" class="form-control cantidad-input" 
                                               min="0" max="{{ producto.cantidad }}" 
                                               placeholder="0" style="width: 70px;">
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex flex-column gap-1">
                                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" 
                                                data-bs-target="#modalEditar{{ producto.id_producto }}">
                                            Editar
                                        </button>
                                        <button type="button" class="btn btn-danger btn-sm" 
                                                onclick="if(confirm('¿Estás seguro de que quieres eliminar el producto {{ producto.nombre }}?')) { document.getElementById('deleteForm{{ producto.id_producto }}').submit(); }">
                                            Borrar
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="7" class="text-center py-4">
                                    {% if busqueda or filtro_nombre or filtro_codigo or filtro_stock_min or filtro_stock_max %}
                                    <div class="text-muted">
                                        <i class="bi bi-search display-4"></i>
                                        <h5>No se encontraron productos</h5>
                                        <p>No hay resultados con los filtros aplicados</p>
                                        <a href="{{ url_for('products') }}" class="btn btn-primary">
                                            <i class="bi bi-arrow-left"></i> Ver todos los productos
                                        </a>
                                    </div>
                                    {% else %}
                                    <div class="text-muted">
                                        <i class="bi bi-box display-4"></i>
                                        <h5>No hay productos</h5>
                                        <p>Comienza agregando el primer producto</p>
                                    </div>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </form>

                {% for producto in productos %}
                <form method="POST" action="{{ url_for('delete_product', id=producto.id_producto) }}" 
                      id="deleteForm{{ producto.id_producto }}" style="display: none;">
                </form>
                {% endfor %}
            </div>

            {% if pagination.pages > 1 %}
            <nav aria-label="Page navigation" class="mt-3">
                <ul class="pagination justify-content-center">
                    <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('products', pagina=pagination.prev_num, busqueda=busqueda, filtro_nombre=filtro_nombre, filtro_codigo=filtro_codigo, filtro_stock_min=filtro_stock_min, filtro_stock_max=filtro_stock_max) if pagination.has_prev else '#' }}">
                            <i class="bi bi-chevron-left"></i> Anterior
                        </a>
                    </li>

                    {% for page_num in pagination.iter_pages(left_edge=2, left_current=2, right_current=2, right_edge=2) %}
                        {% if page_num %}
                            <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                                <a class="page-link" href="{{ url_for('products', pagina=page_num, busqueda=busqueda, filtro_nombre=filtro_nombre, filtro_codigo=filtro_codigo, filtro_stock_min=filtro_stock_min, filtro_stock_max=filtro_stock_max) }}">{{ page_num }}</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        {% endif %}
                    {% endfor %}

                    <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('products', pagina=pagination.next_num, busqueda=busqueda, filtro_nombre=filtro_nombre, filtro_codigo=filtro_codigo, filtro_stock_min=filtro_stock_min, filtro_stock_max=filtro_stock_max) if pagination.has_next else '#' }}">
                            Siguiente <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
            {% endif %}

            <div class="text-center text-muted small mt-2">
                Mostrando {{ productos|length }} de {{ pagination.total }} productos
                (Página {{ pagination.page }} de {{ pagination.pages }})
                {% if busqueda or filtro_nombre or filtro_codigo or filtro_stock_min or filtro_stock_max %}
                <span class="badge bg-info ms-2">Filtros aplicados</span>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalAgregar">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Agregar Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_product') }}" enctype="multipart/form-data">
                <div class="modal-body">
                    <input type="text" name="nombre" class="form-control mb-2" placeholder="Nombre" required>
                    <input type="number" name="cantidad" class="form-control mb-2" placeholder="Cantidad" min="0" required>
                    <input type="text" name="codigo_barras" class="form-control mb-2" placeholder="Código de barras" required>
                    <input type="file" name="imagen" class="form-control" accept="image/*">
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Agregar</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% for producto in productos %}
<div class="modal fade" id="modalEditar{{ producto.id_producto }}">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('edit_product', id=producto.id_producto) }}" enctype="multipart/form-data">
                <div class="modal-body">
                    <input type="text" name="nombre" class="form-control mb-2" placeholder="Nombre" value="{{ producto.nombre }}" required>
                    <input type="number" name="cantidad" class="form-control mb-2" placeholder="Cantidad" value="{{ producto.cantidad }}" min="0" required>
                    <input type="text" name="codigo_barras" class="form-control mb-2" placeholder="Código de barras" value="{{ producto.codigo_barras or '' }}" required>
                    <input type="file" name="imagen" class="form-control" accept="image/*">
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Actualizar</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<form method="POST" action="{{ url_for('generate_package') }}" id="formPaquete" style="display: none;">
    <input type="hidden" name="productos_data" id="productosData">
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const cantidadInputs = document.querySelectorAll('.cantidad-input');
    const btnGenerar = document.getElementById('btnGenerarPaquete');
    const contador = document.getElementById('contador-seleccion');
    const formPaquete = document.getElementById('formPaquete');
    const productosData = document.getElementById('productosData');
    const filterForm = document.getElementById('filterForm');
    const paqueteBadge = document.getElementById('paqueteBadge');

    searchInput.focus();

    function actualizarSeleccion() {
        let totalSeleccionados = 0;
        let totalCantidad = 0;
        let productosSeleccionados = [];
        
        cantidadInputs.forEach(input => {
            const cantidad = parseInt(input.value) || 0;
            if (cantidad > 0) {
                totalSeleccionados++;
                totalCantidad += cantidad;
                const productoId = input.closest('tr').dataset.productoId;
                productosSeleccionados.push({
                    id: productoId,
                    cantidad: cantidad
                });
            }
        });
        
        contador.textContent = `${totalSeleccionados} productos seleccionados`;
        btnGenerar.disabled = totalSeleccionados === 0;
        
        if (paqueteBadge) {
            if (totalSeleccionados > 0) {
                paqueteBadge.textContent = totalSeleccionados;
                paqueteBadge.style.display = 'block';
            } else {
                paqueteBadge.style.display = 'none';
            }
        }
        
        productosData.value = JSON.stringify(productosSeleccionados);
    }

    cantidadInputs.forEach(input => {
        input.addEventListener('input', actualizarSeleccion);
        
        input.addEventListener('change', function() {
            const max = parseInt(this.getAttribute('max')) || 0;
            const value = parseInt(this.value) || 0;
            
            if (value > max) {
                this.value = max;
                actualizarSeleccion();
            }
            
            if (value < 0) {
                this.value = 0;
                actualizarSeleccion();
            }
        });
    });

    btnGenerar.addEventListener('click', function() {
        if (!btnGenerar.disabled) {
            formPaquete.submit();
        }
    });

    const filterInputs = filterForm.querySelectorAll('input[type="text"], input[type="number"]');
    filterInputs.forEach(input => {
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                filterForm.submit();
            }
        });
    });

    actualizarSeleccion();
});
</script>
{% endblock %}